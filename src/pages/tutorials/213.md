---
layout: ../../layouts/tutorial/TextTutorial.astro
title: "How to communicate with applications using TIDL"
description: "TIDL is a programming language to define interfaces for communicating among applications in Tizen. It provides methods to create a Remote Procedure Call (RPC) or Remote Method Invocation (RMI) in Tizen."
created: "2020/07/21"
modified: "2020/07/25"
profile: ["iot"]
type: "dotnet"
level: 1
state: "closed"
thumbnail: ""
---

#

# Overview

## Overview

**구조**

이 프로젝트는 두개의 애플리케이션 (UI앱-C#, Service앱-C) 으로 구성되어 있으며, <br/>TIDL을 이용해서 UI앱에서 Service앱의 함수를 호출하는 방법을 프로젝트입니다.

<img src="/TizenSchool/assets/images/tutorials/213/TIDL구조.jpg" style="height:555px; width:1000px"/>

# TIDL

## Compile Proxy and Stub

참고 : [https://docs.tizen.org/application/native/guides/app-management/tidl/](https://docs.tizen.org/application/native/guides/app-management/tidl/)

1. tidl 파일 생성

C:\타이젠스튜디오\platforms\tizen-5.5\common\tidl\ 폴더로 이동합니다.

school.txt 파일을 하나 만들고, Interface를 작성합니다.

```vim
struct Student {
  string name;
  int num;
  bundle data;
}

interface ISchool {
	int Register(Student s);
}
```

2. proxy 코드 생성 (C#)

<img src="/TizenSchool/assets/images/tutorials/213/TIDL_PROXY.JPG" style="height:239px; width:981px"/>

3. stub 코드 생성 (C)

<img src="/TizenSchool/assets/images/tutorials/213/TIDL_STUB.JPG" style="height:259px; width:980px"/>

## Introduce Proxy

**Generated C# Code**

```csharp
public sealed class Student
{
    public string name { get; set; }
    public int num { get; set; }
    public Bundle data { get; set; }

    public Student()
    {
         data = new Bundle();
    }
}

namespace Proxy
{
    public class ISchool : ProxyBase
    {
        public event EventHandler Connected;
        public event EventHandler Disconnected;
        public event EventHandler Rejected;
        ....

        public ISchool(string appId)


        /// <summary>
        /// Connects to the service app.
        /// </summary>
        /// <privilege>http://tizen.org/privilege/appmanager.launch</privilege>
        /// <privilege>http://tizen.org/privilege/datasharing</privilege>
        /// <exception cref="InvalidIDException">
        /// Thrown when the appid to connect is invalid.
        /// </exception>
        /// <exception cref="InvalidIOException">
        /// Thrown when internal I/O error happen.
        /// </exception>
        /// <exception cref="PermissionDeniedException">
        /// Thrown when the permission is denied.
        /// </exception>
        /// <remark> If you want to use this method, you must add privileges.</remark>
        public void Connect()

        public int Register(Student s)
     }
}
```

**public sealed class Student**

tidl 파일에서 정의한 Student Class

**public EventHandler Connected<br/>public EventHandler DisConnected<br/>public EventHandler Rejected**

Stub에 접속이 성공했을때, 접속이 끊어졌을때, 접속이 거부됐을때 불리는 EventHandler를 등록할 수 있습니다.

**public void Connect()**

Stub에 접속합니다.

이 Method를 호출하기 위해 <br/><privilege>http://tizen.org/privilege/appmanager.launch</privilege><br/><privilege>http://tizen.org/privilege/datasharing</privilege><br/>Privilege가 필요합니다.

**public int Register(Student s)**

tidl 파일에서 정의한 함수로 Stub의 Register 함수를 호출합니다.

## Introduce Stub

**Generated C code**

```c
/*
 * Generated by tidlc 1.3.17.
 */

#pragma once

#include <stdbool.h>
#include <bundle.h>

#ifdef __cplusplus
extern "C" {
#endif

typedef struct Student_s *rpc_port_Student_h;

int rpc_port_Student_create(rpc_port_Student_h *h);

int rpc_port_Student_destroy(rpc_port_Student_h h);

int rpc_port_Student_clone(rpc_port_Student_h h, rpc_port_Student_h *clone);

int rpc_port_Student_set_name(rpc_port_Student_h h, const char *name);

int rpc_port_Student_set_num(rpc_port_Student_h h, int num);

int rpc_port_Student_set_data(rpc_port_Student_h h, bundle *data);

int rpc_port_Student_get_name(rpc_port_Student_h h, char **name);

int rpc_port_Student_get_num(rpc_port_Student_h h, int *num);

int rpc_port_Student_get_data(rpc_port_Student_h h, bundle **data);

typedef struct ISchool_context_s* rpc_port_stub_ISchool_context_h;

int rpc_port_stub_ISchool_context_set_tag(rpc_port_stub_ISchool_context_h ctx, void *tag);

int rpc_port_stub_ISchool_context_get_tag(rpc_port_stub_ISchool_context_h ctx, void **tag);

int rpc_port_stub_ISchool_context_get_sender(rpc_port_stub_ISchool_context_h ctx, char **sender);

typedef struct {
	void (*create)(rpc_port_stub_ISchool_context_h context, void *user_data);
	void (*terminate)(rpc_port_stub_ISchool_context_h context, void *user_data);

	int (*Register)(rpc_port_stub_ISchool_context_h context, rpc_port_Student_h s, void *user_data);
} rpc_port_stub_ISchool_callback_s;

int rpc_port_stub_ISchool_register(rpc_port_stub_ISchool_callback_s *callback, void *user_data);

int rpc_port_stub_ISchool_unregister(void);

int rpc_port_stub_ISchool_get_client_number(unsigned int *n);

#ifdef __cplusplus
}
#endif
```

<br/> **void (*create)(rpc_port_stub_ISchool_context_h context, void *user_data);**

Proxy에서 Stub에 접속했을때 호출 되는 함수입니다.

<br/> **void (*terminate)(rpc_port_stub_ISchool_context_h context, void *user_data);**

Proxy에서 Stub에 접속을 끊었을 때 호출되는 함수입니다.

**int (*Register)(rpc_port_stub_ISchool_context_h context, rpc_port_Student_h s, void *user_data);**

tidl 파일에서 정의한 interface 함수입니다.

Proxy에서 Register 함수를 사용하면 호출되는 함수입니다.

**int rpc_port_stub_ISchool_register(rpc_port_stub_ISchool_callback_s *callback, void *user_data);**

Stub에서 Proxy의 요청을 받기위해 callback 함수를 등록하는 코드입니다.

**int rpc_port_stub_ISchool_unregister(void);**

Stub에서 Proxy의 요청을 받지 않기위해 호출할 함수입니다.

# Service Application (C)

## Create Service Application

**1. 애플리케이션 생성**

참고 : [https://docs.tizen.org/application/native/guides/applications/service-app/](https://docs.tizen.org/application/native/guides/applications/service-app/)

타이젠 스튜디오에서 새로운 Tizen Project를 선택하고 Template -> Native Application -> Service 를 선택하여 새로운 Application을 생성합니다.

sample 코드에 맞게 동작하기 위해 Application 이름은 "sample_tidl_service_app" 으로 하겠습니다.

<img src="/TizenSchool/assets/images/tutorials/200/CreateServiceApp.JPG" style="height:353px; width:500px"/>

**2. Background Category 등록**

Service application이 background에서 계속 동작하도록 background category를 등록해줍니다.

애플리케이션의 tizen-manifest.xml에서 Advanced -> Background Category 에 iot-communication을 하나 추가해줍니다.

<img src="/TizenSchool/assets/images/tutorials/200/backgroundcategory.JPG" style="height:276px; width:650px"/>

## Create Stub

**1. Load stub file**

TIDL 챕터에서 생성했던 stub 파일을 service application에 추가합니다.

<img src="/TizenSchool/assets/images/tutorials/213/loadstub.jpg" style="height:337px; width:317px"/>

**2. Callback 등록**

sample_tidl_service_app.c 파일에서 tidl로 생성된 코드를 include 합니다.

```c
#include <tizen.h>
#include <service_app.h>
#include "sample_tidl_service_app.h"
#include "stub_school.h"
```

UI application과 연결이 되고, 함수 호출이 들어왔을 때 호출 될 Callback 함수를 sample_tidl_service_app.c 파일에서 등록합니다.

```c
static rpc_port_stub_ISchool_callback_s __callback;

void __create (rpc_port_stub_ISchool_context_h context, void *user_data)
{
	dlog_print(DLOG_INFO, LOG_TAG, "Create stub");
}
void __terminate (rpc_port_stub_ISchool_context_h context, void *user_data)
{
	dlog_print(DLOG_INFO, LOG_TAG, "Terminate stub");
}

int __register (rpc_port_stub_ISchool_context_h context, rpc_port_Student_h s, void *user_data)
{
	dlog_print(DLOG_INFO, LOG_TAG, "Register stub");
	return -1;
}

bool service_app_create(void *data)
{
    int ret;

    __callback.create = __create;
    __callback.terminate = __terminate;
    __callback.Register = __register;

    ret = rpc_port_stub_ISchool_register(&__callback, NULL);
    if (ret != 0)
    	dlog_print(DLOG_ERROR, LOG_TAG, "Register stub error");
    else
        dlog_print(DLOG_INFO, LOG_TAG, "Success register stub");

    return true;
}

```

<br/> 

## Register Student and Return

**Remote Function 구현**

**1. Register 코드 작성**

Proxy에서 넘겨준 Paramter 데이터를 통해 Student 정보를 얻어옵니다.

```c
int __register (rpc_port_stub_ISchool_context_h context, rpc_port_Student_h s, void *user_data)
{
	dlog_print(DLOG_INFO, LOG_TAG, "Register stub");

	char* name;
	int num;
	bundle* data;
	char* val;
	int ret;

	ret = rpc_port_Student_get_name(s, &name);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Get Name Error : %d", ret);

	ret = rpc_port_Student_get_num(s, &num);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Get num Error : %d", ret);

	ret = rpc_port_Student_get_data(s, &data);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Get data Error : %d", ret);

	bundle_get_str(data, "key", &val);

	dlog_print(DLOG_INFO, LOG_TAG, "Student Name : %s", name);
	dlog_print(DLOG_INFO, LOG_TAG, "Student Num : %d", num);
	dlog_print(DLOG_INFO, LOG_TAG, "Student data val : %s", val);

	return 0;
}
```

**2. Student List 생성**

Student 데이터를 저장할 자료구조를 만듭니다.

```c
#include <glib.h>

static GList* __student_list;
```

**3. Student List에 데이터 저장**

Proxy에서 넘겨준 parameter로 부터 데이터를 생성해서 Student 데이터를 저장합니다.

```c
int __register (rpc_port_stub_ISchool_context_h context, rpc_port_Student_h s, void *user_data)
{
	dlog_print(DLOG_INFO, LOG_TAG, "Register stub");

	char* name;
	int num;
	bundle* data;
	char* val;
	int ret;
	rpc_port_Student_h cloned;

	ret = rpc_port_Student_get_name(s, &name);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Get Name Error : %d", ret);

	ret = rpc_port_Student_get_num(s, &num);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Get num Error : %d", ret);

	ret = rpc_port_Student_get_data(s, &data);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Get data Error : %d", ret);

	bundle_get_str(data, "key", &val);

	dlog_print(DLOG_INFO, LOG_TAG, "Student Name : %s", name);
	dlog_print(DLOG_INFO, LOG_TAG, "Student Num : %d", num);
	dlog_print(DLOG_INFO, LOG_TAG, "Student data val : %s", val);

	ret = rpc_port_Student_clone(s, &cloned);
	if (ret != 0)
		dlog_print(DLOG_ERROR, LOG_TAG, "Clone student Error : %d", ret);

	__student_list = g_list_append(__student_list, cloned);

	dlog_print(DLOG_INFO, LOG_TAG, "Num of Students: %d", g_list_length(__student_list));

	return 0;
}
```

# UI Application (C#)

## Introduce API

**bundle API**

1. public Bundle()

번들 객체를 생성합니다.

2. public void AddItem(string key, string value)

번들 객체에 데이터를 넣어줍니다.

## Create UI Application

**1. 애플리케이션 생성**

참고 : [https://docs.tizen.org/application/dotnet/get-started/iot/first-app/](https://docs.tizen.org/application/dotnet/get-started/iot/first-app/)

IOT UI Application을 하나 생성합니다. sample 코드랑 맞추기 위해 프로젝트 이름은 TIDLSample로 하겠습니다.

<img src="https://docs.tizen.org/application/dotnet/get-started/iot/media/cs_first_building_device.png" style="height:270px; width:480px"/>

**2. 버튼 생성**

Stub에 연결하기 위한 버튼과 Register함수를 호출할 버튼을 하나씩 생성합니다.

MainPage.xaml 수정

```xml
    <ContentPage.Content>
        <StackLayout>
            <Label Text="Welcome to TIDL Proxy Application!"
                VerticalOptions="CenterAndExpand"
                HorizontalOptions="CenterAndExpand" />
            <Button Text="Connect"
                BackgroundColor="Red"
                HorizontalOptions="CenterAndExpand"
                VerticalOptions="CenterAndExpand"
                Clicked="ConnectButtonClicked" />
            <Button Text="Register"
                BackgroundColor="Blue"
                HorizontalOptions="CenterAndExpand"
                VerticalOptions="CenterAndExpand"
                Clicked="RegisterButtonClicked" />
        </StackLayout>
    </ContentPage.Content>
```

MainPage.xaml.cs 수정

```csharp
    [XamlCompilation(XamlCompilationOptions.Compile)]
    public partial class MainPage : ContentPage
    {
        public MainPage()
        {
            InitializeComponent();
        }

        void ConnectButtonClicked(object sender, EventArgs args)
        {
        }

        void RegisterButtonClicked(object sender, EventArgs args)
        {
        }
    }
```

## Install Tizen.NET nuget package

**1,  Nuget 패키지 관리 선택**

<img src="/TizenSchool/assets/images/tutorials/200/Nuget.jpg" style="height:490px; width:1000px"/>

**2. Tizen.NET 6.0 설치**

<img src="/TizenSchool/assets/images/tutorials/200/Nuget2.jpg" style="height:487px; width:1000px"/>

## Create Proxy

**1. Load Proxy**

<img src="/TizenSchool/assets/images/tutorials/213/loadproxy.jpg" style="height:547px; width:354px"/>

**2. Privilege 추가**

Connect 함수를 실행하기 위해서 아래 두개의 Privilege를 추가합니다.

<privilege>http://tizen.org/privilege/appmanager.launch</privilege><br/><privilege>http://tizen.org/privilege/datasharing</privilege>

<img src="/TizenSchool/assets/images/tutorials/213/ProxyPrivilege.JPG" style="height:285px; width:1000px"/>

**2. ISchool 인스턴스**

Proxy namespace를 추가하고 ISchool의 인스턴스를 생성합니다.

```csharp
using RPCPort.ProxySchool.Proxy;


namespace TIDLSample
{
    [XamlCompilation(XamlCompilationOptions.Compile)]
    public partial class MainPage : ContentPage
    {
        ISchool school;
        ...

```

**3. EventHandler**

새로운 인스턴스를 만들고, 각 EventHandler를 등록해줍니다.

```csharp
    [XamlCompilation(XamlCompilationOptions.Compile)]
    public partial class MainPage : ContentPage
    {
        ISchool school;

        public MainPage()
        {
            InitializeComponent();

            school = new ISchool("org.example.sample_tidl_service_app");

            school.Connected += OnConnected;
            school.Disconnected += OnDisconnected;
            school.Rejected += OnRejected;
        }

        void OnConnected(object sender, EventArgs e)
        {
        }

        void OnDisconnected(object sender, EventArgs e)
        {
        }

        void OnRejected(object sender, EventArgs e)
        {
        }
```

## Connect And Request register

**1. Log 추가**

정상적으로 Connect되고 EventHandler가 불리는지 확인하기 위해 로그를 추가합니다.

```csharp
using Tizen;

...
     string TAG = "TIDLSample";


        void OnConnected(object sender, EventArgs e)
        {
            Log.Debug(TAG, "OnConnected");
        }

        void OnDisconnected(object sender, EventArgs e)
        {
            Log.Debug(TAG, "OnDisconnected");
        }

        void OnRejected(object sender, EventArgs e)
        {
            Log.Debug(TAG, "OnRejected");
        }
```

**2. Connect 코드 추가**

Stub에 Connect 하는 코드를 추가합니다.

```csharp
        void ConnectButtonClicked(object sender, EventArgs args)
        {
            school.Connect();
        }
```

**3. Register 코드 추가**

Student 데이터를 Register요청하는 코드를 추가합니다.

```csharp
using RPCPort.ProxySchool;
using Tizen.Applications;

...

        void RegisterButtonClicked(object sender, EventArgs args)
        {
            Student s = new Student();
            s.name = "MyName";
            s.num = 14;
            s.data = new Bundle();
            s.data.AddItem("key", "value");
            int ret = school.Register(s);
            Log.Debug(TAG, "Register Success " + ret);
        }
```

# Test Register

## Test

**1. sample_tidl_service_app 실행**

Service App을 먼저 실행합니다.

<img src="/TizenSchool/assets/images/tutorials/200/ServiceApp 실행.jpg" style="height:546px; width:1000px"/>

**2. Device Manager로 로그 확인**

Alt + Shift + V 혹은 상단메뉴 Tools -> Device Manager를 선택합니다.

앱을 실행 하고 정상적으로 실행 되었는지 Tag 에서 "sample_tidl_service_app" 만 Filtering 해서 로그를 확인합니다.

<img src="/TizenSchool/assets/images/tutorials/213/DeviceManager.JPG" style="height:262px; width:998px"/>

**3. TIDLSample 앱 실행**

Visual Studio에서 Log Viewer를 키고 UI App을 실행합니다.

<img src="/TizenSchool/assets/images/tutorials/213/TIDLUI.jpg" style="height:445px; width:1000px"/>

**4. Connect And Register**

Connect 버튼을 클릭하고 정상적으로 Connect 됐는지 확인합니다.

그 다음 Register 버튼을 클릭해서 정상적으로 Register 하고 return 값을 받는지 확인합니다.
