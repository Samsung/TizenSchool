---
layout: ../../layouts/tutorial/TextTutorial.astro
title: 'How to create "SquatCounter" application'
description: "Tutorial guides you how to use pressure sensor to count squats."
created: "2020/04/17"
modified: "2020/04/27"
profile: ["wearable"]
type: "dotnet"
level: 2
state: "open"
thumbnail: "/assets/images/tutorials/180/Squat_counter_thumbnail@2x (1).png"
---

#

# I. Introduction

## 1. Overview

In this tutorial, we will learn how to create a **_SquatCounter_** application using Pressure Sensor from Tizen.Senor.API. This application allow to count squats based on pressure changes.

The tutorial consists of 3 chapters:

Before you start the tutorial you should be familiar with basics of C# and Xamarin.Forms.

<img src="/assets/images/tutorials/180/step1.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/step2.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/step3.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/clockpage.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/squatcounterpage.png" style="height:360px; width:360px"/>

## 2. Setting up enviroment

To build and run the Tizen application the following environment is required:

## 3. Create new project

Now we will prepare a project base for future parts of the tutorial.

<br/> **Step 1.** Open  **_Visual Studio IDE_**  to create a new  **_Tizen Wearable Xaml App_** .

**Step 2.** Add/remove files

**Step 3.** Create folder structure.

After passing through all the steps, the structure of the project should look like in the following image.<br/>
<img src="/assets/images/tutorials/180/devenv_C0USemKPJd.png" style="height:602px; width:300px"/>

## 4. Adding the assets

**Step 1.**  Download and unpack the [assets](https://tizenschool.org/assets/images/tutorials/180/assets.zip) for the application.

The assets pack consists of two folders ...

<img src="/assets/images/tutorials/145/adding-the-assets-1.png" style="undefined"/>

... which contain following set of images:

**Step 2.** Select the unpacked folders, that is  **_res_**  and  **_shared_** , and copy them with context menu or press  **_Control + C_** . Next, make a left mouse click on the project name  **_SquatCounter_**  in the  **_Solution Explorer_**  and press  **_Control + V_** , to paste copied folders directly to the **_SquatCounter_**  project.

**Step 3.**  Confirm following pop-ups to replace the content of the  **_res_**  and **_shared_**  folders of the project.

<img src="/assets/images/tutorials/145/confirm1.png" style="height:182px; width:503px"/>

<img src="/assets/images/tutorials/145/confirm2.png" style="undefined"/>

# II. Application Logic

## 1. Goal

In this chapter, we will develop the application logic. We will:

## 2. Implement services - part 1

Let's start with the implementation of the page navigation service based on singleton design pattern. This service will provide navigation between pages across the application

**Step 1.** Go to Solution Explorer, right click on folder  **_Services_** , select **_Add > New item_** from the context menu, choose **_class_**  and name it **_PageNavigationService_** **_.cs_** .

**Step 2.** Let's modify our class based on principles of the  **_singleton_** design pattern.

```csharp
namespace SquatCounter.Services
{
    public sealed class PageNavigationService
    {
        private static PageNavigationService _instance;

        public static PageNavigationService Instance
        {
            get => _instance ?? (_instance = new PageNavigationService());
        }
    }
}
```

<br/> **Step 3.** Right-click on the **_Views_**  folder, **select** **_Add > New Item_** from the context menu, choose **_C_** **_ontent page_** and name it **_GuidePage.xaml_** .

<br/> **Step 4.** Next, we will add  _GoToGuidePage_ method that will display  **_GuidePage._** We will also create a body of  **_GoToSquatCounterPage_** method, which will be completed in later parts of tutorial _._

<highlight>1-2,15-23</highlight>

```csharp
using SquatCounter.Views;
using Xamarin.Forms;

namespace SquatCounter.Services
{
    public sealed class PageNavigationService
    {
        private static PageNavigationService _instance;

        public static PageNavigationService Instance
        {
            get => _instance ?? (_instance = new PageNavigationService());
        }

        public void GoToGuidePage()
        {
            Application.Current.MainPage = new NavigationPage(new GuidePage());
        }

        public void GoToSquatCounterPage()
        {

        }
    }
}

```

**Step 6.** The last thing we need to do is modify **_App.cs_** constructor to display the guide page. At line no. 5 we have added compile-time checking all XAML files within namespace. It will help us to notice errors while compile-time, improves performance of the views and reduce size of the our application.

<highlight>1,5,12</highlight>

```csharp
using SquatCounter.Services;
using Xamarin.Forms;
using Xamarin.Forms.Xaml;

[assembly: XamlCompilation(XamlCompilationOptions.Compile)]
namespace SquatCounter
{
    public class App : Application
    {
        public App()
        {
            PageNavigationService.Instance.GoToGuidePage();
        }
    }
}

```

After build and run application we should see following screen.

<img src="/assets/images/tutorials/180/default_page.png" style="height:360px; width:360px"/>

## 3. Implement services - part 2

Now we will implement a service for **_Pressure Sensor_** . It will allow us to obtain pressure data from instance of  **_Pressure Sensor_**  and this data will be used later to count squats.

**Step 1.** Go to Solution Explorer, right click on **_Services_** folder, select **_Add > New item_** from the context menu, choose **_class_**  and name it **_PressureSensorService.cs_** .<br/>

**Step 2.** Let's modify our  **_PressureSensorService.cs_** class. Before we start implementing the pressure sensor we need to change class access modifier to public and create public constructor with empty body.

<highlight>3-9</highlight>

```csharp
namespace SquatCounter.Services
{
    public class PressureSensorService
    {
        public PressureSensorService()
        {

        }
    }
}


```

<br/> **Step 3.** Next, we need to add **_PressureSensor_**  instance which allow us to obtain pressure data.

<highlight>1,7</highlight>

```csharp
using Tizen.Sensor;

namespace SquatCounter.Services
{
    public class PressureSensorService
    {
        private readonly PressureSensor _pressureSensor;

        public PressureSensorService()
        {

        }
    }
}


```

<br/> **Step 4.** Before we create the instance of  **_PressureSensor_** we need to add following properties and method.

<highlight>9-11,18-21</highlight>

```csharp
using Tizen.Sensor;

namespace SquatCounter.Services
{
    public class PressureSensorService
    {
        private readonly PressureSensor _pressureSensor;

        private const string NotSupportedMsg = "Pressure sensor is not supported on your device.";

        private const int Interval = 10;

        public PressureSensorService()
        {

        }

        private void PressureSensorUpdated(object sender, PressureSensorDataUpdatedEventArgs e)
        {

        }
    }
}


```

<br/> **Step 5.** In this step we will create and start instance of  **PressureSensore** in the constructor body of **_PressureSensorService_** .

<highlight>2,16-24</highlight>

```csharp
using Tizen.Sensor;
using System;

namespace SquatCounter.Services
{
    public class PressureSensorService
    {
        private PressureSensor _pressureSensor;

        private const string NotSupportedMsg = "Pressure sensor is not supported on your device.";

        private const int Interval = 10;

        public PressureSensorService()
        {
            if (!PressureSensor.IsSupported)
            {
                throw new NotSupportedException(NotSupportedMsg);
            }

            _pressureSensor = new PressureSensor();
            _pressureSensor.DataUpdated += PressureSensorUpdated;
            _pressureSensor.Interval = Interval;
            _pressureSensor.Start();
        }

        private void PressureSensorUpdated(object sender, PressureSensorDataUpdatedEventArgs e)
        {

        }
    }
}

```

<br/> **Step 6.** In this step we will create eventhandler, which is invoked whenever **_PressueSensorUpdate_** callback has been rised.

<highlight>12,31</highlight>

```csharp
using System;
using Tizen.Sensor;

namespace SquatCounter.Services
{
    public class PressureSensorService
    {
        private PressureSensor _pressureSensor;

        private const string NotSupportedMsg = "Pressure sensor is not supported on your device.";

        public event EventHandler<float> ValueUpdated;

        private const int Interval = 10;

        public PressureSensorService()
        {
            if (!PressureSensor.IsSupported)
            {
                throw new NotSupportedException(NotSupportedMsg);
            }

            _pressureSensor = new PressureSensor();
            _pressureSensor.DataUpdated += PressureSensorUpdated;
            _pressureSensor.Interval = Interval;
            _pressureSensor.Start();
        }

        private void PressureSensorUpdated(object sender, PressureSensorDataUpdatedEventArgs e)
        {
            ValueUpdated?.Invoke(this, e.Pressure);
        }
    }
}

```

<br/> **Step 7.** The late thing that we need to do is release resources obtained by PressureSensor. To achieve this we will use Dispose pattern.<br/>This step is very important for our application. If we do not release the resources, then the application may crashed.

<highlight>31-36</highlight>

```csharp
namespace SquatCounter.Services
{
    public class PressureSensorService : IDisposable
    {
        private PressureSensor _pressureSensor;

        private const string NotSupportedMsg = "Pressure sensor is not supported on your device.";

        public event EventHandler<float> ValueUpdated;

        private const int Interval = 10;

        public PressureSensorService()
        {
            if (!PressureSensor.IsSupported)
            {
                throw new NotSupportedException(NotSupportedMsg);
            }

            _pressureSensor = new PressureSensor();
            _pressureSensor.DataUpdated += PressureSensorUpdated;
            _pressureSensor.Interval = Interval;
            _pressureSensor.Start();
        }

        private void PressureSensorUpdated(object sender, PressureSensorDataUpdatedEventArgs e)
        {
            ValueUpdated?.Invoke(this, e.Pressure);
        }

        public void Dispose()
        {
            _pressureSensor?.Stop();
            _pressureSensor.DataUpdated -= PressureSensorUpdated;
            _pressureSensor?.Dispose();
        }
    }
}

```

## 4. Implement services - part 3

The data we receive from the sensor must be processed in order to obtain the necessary information from it. Now we can create our counting squats logic with the following points:

**Step 1.** Go to Solution Explorer, right click on **_Services_** folder, select **_Add > New item_** from the context menu, choose C# **_class_** and name it **\*SquatCounterService** **.cs\*** .

**Step 2.** To obtain data from **PressureSensorService** we need to add following things.

<highlight>3-17</highlight>

```csharp
namespace SquatCounter.Services
{
    public class SquatCounterService
    {
        private PressureSensorService _pressureService;

        public SquatCounterService()
        {
            _pressureService = new PressureSensorService();
            _pressureService.ValueUpdated += PressureSensorUpdated;
        }

        private void PressureSensorUpdated(object sender, float pressure)
        {

        }
    }
}


```

<br/> **Step 3.** Next, we will add following methods and fields for service calibration and calculate stable average. CalculateStableAverage method

<highlight>1-2,8-9,12-17,21,32-46</highlight>

```csharp
using System.Collections.Generic;
using System.Linq;

namespace SquatCounter.Services
{
    public class SquatCounterService
    {
        private const float Accuracy = 0.030F;
        private const int WindowSize = 10;

        private PressureSensorService _pressureService;
        private Queue<float> _pressureWindow;

        private float _upperThreshold;
        private float _lowerThreshold;
        private bool _valueExceededUpperThreshold;
        private bool _isServiceCalibrated;

        public SquatCounterService()
        {
            _pressureWindow = new Queue<float>();

            _pressureService = new PressureSensorService();
            _pressureService.ValueUpdated += PressureSensorUpdated;
        }

        private void PressureSensorUpdated(object sender, float pressure)
        {

        }

        private void CalibrateService()
        {
            float average = CalculateStableAverage();
            _upperThreshold = average + Accuracy;
            _lowerThreshold = average - Accuracy;
            _isServiceCalibrated = true;
        }

        private float CalculateStableAverage()
        {
            float minPressure = _pressureWindow.Min();
            float maxPressure = _pressureWindow.Max();
            float sum = _pressureWindow.Sum();
            return (sum - minPressure - maxPressure) / (WindowSize - 2);
        }
    }
}

```

<br/> **Step 4.** In this step we will add previously created method to calibrate SquatCounter after PressureWindow reach first 10 readings.

<highlight>29-40</highlight>

```csharp
using System.Collections.Generic;
using System.Linq;

namespace SquatCounter.Services
{
    public class SquatCounterService
    {
        private const float Accuracy = 0.030F;
        private const int WindowSize = 10;

        private PressureSensorService _pressureService;
        private Queue<float> _pressureWindow;

        private float _upperThreshold;
        private float _lowerThreshold;
        private bool _valueExceededUpperThreshold;
        private bool _isServiceCalibrated;

        public SquatCounterService()
        {
            _pressureWindow = new Queue<float>();

            _pressureService = new PressureSensorService();
            _pressureService.ValueUpdated += PressureSensorUpdated;
        }

        private void PressureSensorUpdated(object sender, float pressure)
        {
            _pressureWindow.Enqueue(pressure);

            if (_pressureWindow.Count < WindowSize)
            {
                return;
            }
            else if (_pressureWindow.Count == WindowSize && !_isServiceCalibrated)
            {
                CalibrateService();
            }

            _pressureWindow.Dequeue();
        }

        private void CalibrateService()
        {
            float average = CalculateStableAverage();
            _upperThreshold = average + Accuracy;
            _lowerThreshold = average - Accuracy;
            _isServiceCalibrated = true;
        }

        private float CalculateStableAverage()
        {
            float minPressure = _pressureWindow.Min();
            float maxPressure = _pressureWindow.Max();
            float sum = _pressureWindow.Sum();
            return (sum - minPressure - maxPressure) / (WindowSize - 2);
        }
    }
}

```

<br/> **Step 5.** Next, we will create method that analyze our pressure window to detect hit to the starting calibration. This method will be rising event and pass counted squats every time when squat is detected.

<highlight>1,20,22,45,68-80</highlight>

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

namespace SquatCounter.Services
{
    public class SquatCounterService
    {
        private const float Accuracy = 0.030F;
        private const int WindowSize = 10;

        private PressureSensorService _pressureService;
        private Queue<float> _pressureWindow;

        private float _upperThreshold;
        private float _lowerThreshold;
        private bool _valueExceededUpperThreshold;
        private bool _isServiceCalibrated;

        public event EventHandler<int> SquatsUpdated;

        public int SquatsCount { get; private set; }

        public SquatCounterService()
        {
            _pressureWindow = new Queue<float>();

            _pressureService = new PressureSensorService();
            _pressureService.ValueUpdated += PressureSensorUpdated;
        }

        private void PressureSensorUpdated(object sender, float pressure)
        {
            _pressureWindow.Enqueue(pressure);

            if (_pressureWindow.Count < WindowSize)
            {
                return;
            }
            else if (_pressureWindow.Count == WindowSize && !_isServiceCalibrated)
            {
                CalibrateService();
            }

            AnalyzeNewWindow();

            _pressureWindow.Dequeue();
        }

        private void CalibrateService()
        {
            float average = CalculateStableAverage();
            _upperThreshold = average + Accuracy;
            _lowerThreshold = average - Accuracy;
            _isServiceCalibrated = true;
        }

        private float CalculateStableAverage()
        {
            float minPressure = _pressureWindow.Min();
            float maxPressure = _pressureWindow.Max();
            float sum = _pressureWindow.Sum();
            return (sum - minPressure - maxPressure) / (WindowSize - 2);
        }

        private void AnalyzeNewWindow()
        {
            float average = CalculateStableAverage();

            if (average <= _upperThreshold && average >= _lowerThreshold && _valueExceededUpperThreshold)
            {
                _valueExceededUpperThreshold = false;
                SquatsCount++;
                SquatsUpdated.Invoke(this, SquatsCount);
            }
            else if (average > _upperThreshold)
            {
                _valueExceededUpperThreshold = true;
            }
        }
    }
}


```

<br/> **Step 6.** Add stop, start, reset methods and implement dispose pattern to release manged resources.

<highlight>32-52</highlight>

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

namespace SquatCounter.Services
{
    public class SquatCounterService : IDisposable
    {
        private const float Accuracy = 0.030F;
        private const int WindowSize = 10;

        private PressureSensorService _pressureService;
        private Queue<float> _pressureWindow;

        private float _upperThreshold;
        private float _lowerThreshold;
        private bool _valueExceededUpperThreshold;
        private bool _isServiceCalibrated;

        public event EventHandler<int> SquatsUpdated;

        public int SquatsCount { get; private set; }

        public SquatCounterService()
        {
            _pressureWindow = new Queue<float>();

            _pressureService = new PressureSensorService();
            _pressureService.ValueUpdated += PressureSensorUpdated;
        }

        public void Start()
        {
            _pressureService.ValueUpdated += PressureSensorUpdated;
        }

        public void Stop()
        {
            _pressureService.ValueUpdated -= PressureSensorUpdated;
        }

        public void Reset()
        {
            SquatsCount = 0;
            SquatsUpdated.Invoke(this, SquatsCount);
        }

        public void Dispose()
        {
            _pressureService.ValueUpdated -= PressureSensorUpdated;
            _pressureService?.Dispose();
        }

        private void PressureSensorUpdated(object sender, float pressure)
        {
            _pressureWindow.Enqueue(pressure);

            if (_pressureWindow.Count < WindowSize)
            {
                return;
            }
            else if (_pressureWindow.Count == WindowSize && !_isServiceCalibrated)
            {
                CalibrateService();
            }

            AnalyzeNewWindow();

            _pressureWindow.Dequeue();
        }

        private void CalibrateService()
        {
            float average = CalculateStableAverage();
            _upperThreshold = average + Accuracy;
            _lowerThreshold = average - Accuracy;
            _isServiceCalibrated = true;
        }

        private float CalculateStableAverage()
        {
            float minPressure = _pressureWindow.Min();
            float maxPressure = _pressureWindow.Max();
            float sum = _pressureWindow.Sum();
            return (sum - minPressure - maxPressure) / (WindowSize - 2);
        }

        private void AnalyzeNewWindow()
        {
            float average = CalculateStableAverage();

            if (average <= _upperThreshold && average >= _lowerThreshold && _valueExceededUpperThreshold)
            {
                _valueExceededUpperThreshold = false;
                SquatsCount++;
                SquatsUpdated.Invoke(this, SquatsCount);
            }
            else if (average > _upperThreshold)
            {
                _valueExceededUpperThreshold = true;
            }
        }
    }
}

```

## 5. Implement viewmodels - part 1

In order to show all the data to the user we need to add a view model, which acts as a connection between the model and the view and it is responsible for the presentation logic.

**Step 1.** In this step we will create our base viewmodel. Go to Solution Explorer, right click on  **_ViewModels_** folder, select **_Add > New item_** from the context menu, choose C# class and name it **_ViewModelBase.cs_** .

**Step 2.** Next, add following code to **ViewModelBase** class.

```csharp
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace SquatCounter.ViewModels
{
    public class ViewModelBase : INotifyPropertyChanged
    {
        public event PropertyChangedEventHandler PropertyChanged;

        protected bool SetProperty<T>(ref T storage, T value, [CallerMemberName] string propertyName = null)
        {
            if (Equals(storage, value))
            {
                return false;
            }

            storage = value;
            OnPropertyChanged(propertyName);
            return true;
        }

        protected void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}
```

**Step 3.** Now we can create our squat counter viewmodel. Go to Solution Explorer, right click on folder **_ViewModels_** , select **_Add > New item_** from the context menu, choose C# class and name it **SquatCounterPageViewModel** **_.cs_** . Created class must inherit from the ViewModelBase class.

<highlight>3</highlight>

```csharp
namespace SquatCounter.ViewModels
{
    public class SquatCounterPageViewModel : ViewModelBase
    {

    }
}


```

<br/> **Step 4.** Let's create our instance of **_SquatCounterService_** , subscribe to service event and create property for couting squats.

<highlight>1,7-25</highlight>

```csharp
using SquatCounter.Services;

namespace SquatCounter.ViewModels
{
    public class SquatCounterPageViewModel : ViewModelBase
    {
        private SquatCounterService _squatService;
        private int _squatsCount;

        public int SquatsCount
        {
            get => _squatsCount;
            set => SetProperty(ref _squatsCount, value);
        }

        public SquatCounterPageViewModel()
        {
            _squatService = new SquatCounterService();
            _squatService.SquatsUpdated += ExecuteSquatsUpdatedCallback;
        }

        private void ExecuteSquatsUpdatedCallback(object sender, int squatsCount)
        {
            SquatsCount = squatsCount;
        }
    }
}

```

<br/> **Step 5.** Next, we need to implement timer to count, create method for subscribing timer tick and property for elapsed time.

<highlight>2-3,12-14,22-26,30-31,36-38,46-50</highlight>

```csharp
using SquatCounter.Services;
using System.Timers;
using System;

namespace SquatCounter.ViewModels
{
    public class SquatCounterPageViewModel : ViewModelBase
    {
        private SquatCounterService _squatService;
        private int _squatsCount;

        private Timer _timer;
        private int _seconds;
        private string _time;

        public int SquatsCount
        {
            get => _squatsCount;
            set => SetProperty(ref _squatsCount, value);
        }

        public string Time
        {
            get => _time;
            set => SetProperty(ref _time, value);
        }

        public SquatCounterPageViewModel()
        {
            _seconds = 0;
            _time = "00:00";

            _squatService = new SquatCounterService();
            _squatService.SquatsUpdated += ExecuteSquatsUpdatedCallback;

            _timer = new Timer(1000);
            _timer.Elapsed += TimerTick;
            _timer.Start();
        }

        private void ExecuteSquatsUpdatedCallback(object sender, int squatsCount)
        {
            SquatsCount = squatsCount;
        }

        private void TimerTick(object sender, EventArgs e)
        {
            _seconds++;
            Time = TimeSpan.FromSeconds(_seconds).ToString("mm\\:ss");
        }
    }
}


```

<br/> **Step 6** . In this step we will implement commands for reset and change state of **_SquatCounterService_** .

<highlight>4-5,18,32-36,38-40,54-55,69-90</highlight>

```csharp
using SquatCounter.Services;
using System.Timers;
using System;
using System.Windows.Input;
using Xamarin.Forms;

namespace SquatCounter.ViewModels
{
    public class SquatCounterPageViewModel : ViewModelBase
    {
        private SquatCounterService _squatService;
        private int _squatsCount;

        private Timer _timer;
        private int _seconds;
        private string _time;

        private bool _isCouting;

        public int SquatsCount
        {
            get => _squatsCount;
            set => SetProperty(ref _squatsCount, value);
        }

        public string Time
        {
            get => _time;
            set => SetProperty(ref _time, value);
        }

        public bool IsCounting
        {
            get => _isCouting;
            set => SetProperty(ref _isCouting, value);
        }

        public ICommand ChangeServiceStateCommand { get; }

        public ICommand ResetCommand { get; }

        public SquatCounterPageViewModel()
        {
            _seconds = 0;
            _time = "00:00";

            _squatService = new SquatCounterService();
            _squatService.SquatsUpdated += ExecuteSquatsUpdatedCallback;

            _timer = new Timer(1000);
            _timer.Elapsed += TimerTick;
            _timer.Start();

            ChangeServiceStateCommand = new Command(ExecuteChangeServiceStateCommand);
            ResetCommand = new Command(ExecuteResetCommand);
        }

        private void ExecuteSquatsUpdatedCallback(object sender, int squatsCount)
        {
            SquatsCount = squatsCount;
        }

        private void TimerTick(object sender, EventArgs e)
        {
            _seconds++;
            Time = TimeSpan.FromSeconds(_seconds).ToString("mm\\:ss");
        }

        private void ExecuteChangeServiceStateCommand()
        {
            if (IsCounting)
            {
                _timer.Stop();
                _squatService.Stop();
            }
            else
            {
                _timer.Start();
                _squatService.Start();
            }

            IsCounting = !IsCounting;
        }

        private void ExecuteResetCommand()
        {
            _squatService.Reset();
            Time = "00:00";
            _seconds = 0;
        }
    }
}


```

<br/> **Step 7.** Now, we need to release resources after page will be popped. Without this app could be crash.

<highlight>16-19,22-33</highlight>

```csharp
        public SquatCounterPageViewModel()
        {
            _seconds = 0;
            _time = "00:00";

            _squatService = new SquatCounterService();
            _squatService.SquatsUpdated += ExecuteSquatsUpdatedCallback;

            _timer = new Timer(1000);
            _timer.Elapsed += TimerTick;
            _timer.Start();

            ChangeServiceStateCommand = new Command(ExecuteChangeServiceStateCommand);
            ResetCommand = new Command(ExecuteResetCommand);

            if (Application.Current.MainPage is NavigationPage navigationPage)
            {
                navigationPage.Popped += OnPagePopped;
            }
        }

        private void OnPagePopped(object sender, NavigationEventArgs e)
        {
            _timer.Elapsed -= TimerTick;
            _timer.Close();
            _squatService.SquatsUpdated -= ExecuteSquatsUpdatedCallback;
            _squatService.Dispose();

            if (Application.Current.MainPage is NavigationPage navigationPage)
            {
                navigationPage.Popped -= OnPagePopped;
            }
        }

```

## 6. Implement viewmodels - part 2

Now we will implement GuideViewModel. It provides logic to present each step of squat.

**Step 1.** Go to Solution Explorer, right click on **_ViewModels_** folder, select **_Add > New item_** from the context menu, choose C# class and name **_GuidePageViewModel_** **_.cs_** . Created class must inherit from the ViewModelBase class.

<highlight>3</highlight>

```csharp
namespace SquatCounter.ViewModels
{
    public class GuidePageViewModel : ViewModelBase
    {
    }
}


```

**Step 2.** In this step we will implement command to moving to next page and property image path for current page guid.

<highlight>1-3,9-20</highlight>

```csharp
using SquatCounter.Services;
using System.Windows.Input;
using Xamarin.Forms;

namespace SquatCounter.ViewModels
{
    public class GuidePageViewModel : ViewModelBase
    {
        public string ImagePath { get; set; }
        public ICommand GoToSquatCounterPageCommand { get; set; }

        public GuidePageViewModel()
        {
            GoToSquatCounterPageCommand = new Command(ExecuteGoToSquatCounterPageCommand);
        }

        public void ExecuteGoToSquatCounterPageCommand()
        {
            PageNavigationService.Instance.GoToSquatCounterPage();
        }
    }
}


```

# III. User interface

## 1. Goal

It is time to deal with the user interface. In this chapter we will create a full UI of the application including **Guide pages** and **_Counting Squat page_** and fill them with data from the viewmodel using binding.

<img src="/assets/images/tutorials/180/step1.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/step2.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/step3.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/clockpage.png" style="height:360px; width:360px"/>

<img src="/assets/images/tutorials/180/squatcounterpage.png" style="height:360px; width:360px"/>

## 2. Implement guide pages

The implementation will consist in modification of the GuidePage, which will display the next pages of squats and clock page. To achieve this we will use Tizen extension to Xamarin.Forms - Cirucular UI.

**Step 1.**  Right-click on the **_Views_**  folder, **select** **_Add > New Item_** from the context menu, choose **_content page_** and name it **_GuideStepPage.xaml_** . Now we can paste the following code to created page.

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
                x:Class="SquatCounter.Views.GuideStepPage">

    <cui:CirclePage.Content>

    </cui:CirclePage.Content>

</cui:CirclePage>
```

**Step 2.** Next, we need to bind imagepath to image to set our step page.

<highlight>8-11</highlight>

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
                x:Class="SquatCounter.Views.GuideStepPage">

    <cui:CirclePage.Content>
        <AbsoluteLayout>
            <Image AbsoluteLayout.LayoutBounds="0, 0, 360, 360"
                   Source="{Binding ImagePath}" />
        </AbsoluteLayout>
    </cui:CirclePage.Content>

</cui:CirclePage>

```

<br/> **Step 3.** We also need to modify file  **_GuideStepPage.xaml.cs_** with following code.

<highlight>1,5</highlight>

```csharp
using Tizen.Wearable.CircularUI.Forms;

namespace SquatCounter.Views
{
    public partial class GuideStepPage : CirclePage
    {
        public GuideStepPage()
        {
            InitializeComponent();
        }
    }
}

```

<br/> **Step 4.** Right-click on the **_Views_**  folder, **select** **_Add > New Item_** from the context menu, choose **_content page_** and name it **_GuideClockPage.xaml_** . Now we can paste following code to created page.

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
             x:Class="SquatCounter.Views.GuideClockPage">

    <cui:CirclePage.Content>

    </cui:CirclePage.Content>

</cui:CirclePage>
```

**Step 5.** The only thing that makes **_GuideStepPage_** different from **_GuideClockPage_** is the command that calls up transition as a gesture to the **_SquatCounterPage_** . Let's bind the command and imagepath to the page.

<highlight>8-16</highlight>

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
                x:Class="SquatCounter.Views.GuideClockPage">

    <cui:CirclePage.Content>
        <AbsoluteLayout>
            <Image AbsoluteLayout.LayoutBounds="0, 0, 360, 360"
                   Source="{Binding ImagePath}">
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding GoToSquatCounterPageCommand}">
                    </TapGestureRecognizer>
                </Image.GestureRecognizers>
            </Image>
        </AbsoluteLayout>
    </cui:CirclePage.Content>

</cui:CirclePage>

```

<br/> **Step 6.** We need modify **_GuideClockPage.xaml.cs_** in similar way as like in **_S_** **_tep 4_** .

<highlight>1,5</highlight>

```csharp
using Tizen.Wearable.CircularUI.Forms;

namespace SquatCounter.Views
{
    public partial class GuideClockPage : CirclePage
    {
        public GuideClockPage()
        {
            InitializeComponent();
        }
    }
}

```

<br/> **Step 7.** Now we have implemented **_GuideStepPage_** for introduce user how to do squats and  **_GuideClockPage_** . Now we can modify **_GuidePage.xaml_**  file with setting pages with following code.

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:IndexPage xmlns="http://xamarin.com/schemas/2014/forms"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
               xmlns:viewModels="clr-namespace:SquatCounter.ViewModels;assembly=SquatCounter"
               xmlns:views="clr-namespace:SquatCounter.Views;assembly=SquatCounter"
               x:Class="SquatCounter.Views.GuidePage"
               NavigationPage.HasNavigationBar="False">

    <cui:IndexPage.Children>
        <views:GuideStepPage>
            <views:GuideStepPage.BindingContext>
                <viewModels:GuidePageViewModel ImagePath="step_1.png" />
            </views:GuideStepPage.BindingContext>
        </views:GuideStepPage>

        <views:GuideStepPage>
            <views:GuideStepPage.BindingContext>
                <viewModels:GuidePageViewModel ImagePath="step_2.png" />
            </views:GuideStepPage.BindingContext>
        </views:GuideStepPage>

        <views:GuideStepPage>
            <views:GuideStepPage.BindingContext>
                <viewModels:GuidePageViewModel ImagePath="step_3.png" />
            </views:GuideStepPage.BindingContext>
        </views:GuideStepPage>

        <views:GuideClockPage>
            <views:GuideClockPage.BindingContext>
                <viewModels:GuidePageViewModel ImagePath="clock.png" />
            </views:GuideClockPage.BindingContext>
        </views:GuideClockPage>
    </cui:IndexPage.Children>

</cui:IndexPage>
```

<br/> **Step 8.** Last thing to do is modify  **_GuidePage.xaml.cs_** file.

<highlight>1,5</highlight>

```csharp
using Tizen.Wearable.CircularUI.Forms;

namespace SquatCounter.Views
{
    public partial class GuidePage : IndexPage
    {
        public GuidePage()
        {
            InitializeComponent();
        }
    }
}

```

After build and run our app we will see four following pages.

## 3. Implement squat counter page

Let's create  **_SquatCounterPage_** , which will be responsible for displaying counted time and squats.

**Step 1.** Right-click on the **_Views_**  folder, **select** **_Add > New Item_** from the context menu, choose **_content page_** and name it **_SquatCounterPage_** **_.xaml_** . Now we can paste following code to created page.

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:viewModels="clr-namespace:SquatCounter.ViewModels;assembly=SquatCounter"
                xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
                x:Class="SquatCounter.Views.SquatCounterPage"
                NavigationPage.HasNavigationBar="False">

    <cui:CirclePage.BindingContext>
        <viewModels:SquatCounterPageViewModel />
    </cui:CirclePage.BindingContext>

    <cui:CirclePage.Content>
        <AbsoluteLayout>
            <Image AbsoluteLayout.LayoutBounds="0, 0, 360, 360"
                   Source="squat_background.png" />
            <Label AbsoluteLayout.LayoutBounds="130, 28, 100, 47"
                   TextColor="#77A6D2"
                   FontFamily="BreezeSans"
                   FontSize="Large"
                   HorizontalTextAlignment="Center"
                   Text="Squats" />
            <Label AbsoluteLayout.LayoutBounds="118, 90, 123, 72"
                   TextColor="#FFFEFE"
                   FontSize="28.50"
                   FontFamily="BreezeSans"
                   HorizontalTextAlignment="Center"
                   Text="{Binding SquatsCount}" />
            <Label AbsoluteLayout.LayoutBounds="148, 184, 64, 27"
                   FontFamily="BreezeSans"
                   FontSize="Small"
                   HorizontalTextAlignment="Center"
                   TextColor="#77A6D2"
                   Text="Time" />
            <Label AbsoluteLayout.LayoutBounds="133, 228, 94, 29"
                   TextColor="#FFFEFE"
                   FontFamily="BreezeSans"
                   FontSize="Large"
                   HorizontalTextAlignment="Center"
                   Text="{Binding Time}" />
            <AbsoluteLayout.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ChangeServiceStateCommand}" />
            </AbsoluteLayout.GestureRecognizers>
        </AbsoluteLayout>
    </cui:CirclePage.Content>

</cui:CirclePage>
```

**Step 2.** Now we need to add  **_action button_** from Ciruclar UI to reset timer and counted squats.

<highlight>47-51</highlight>

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:viewModels="clr-namespace:SquatCounter.ViewModels;assembly=SquatCounter"
                xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
                x:Class="SquatCounter.Views.SquatCounterPage"
                NavigationPage.HasNavigationBar="False">

    <cui:CirclePage.BindingContext>
        <viewModels:SquatCounterPageViewModel />
    </cui:CirclePage.BindingContext>

    <cui:CirclePage.Content>
        <AbsoluteLayout>
            <Image AbsoluteLayout.LayoutBounds="0, 0, 360, 360"
                   Source="squat_background.png" />
            <Label AbsoluteLayout.LayoutBounds="130, 28, 100, 47"
                   TextColor="#77A6D2"
                   FontFamily="BreezeSans"
                   FontSize="Large"
                   HorizontalTextAlignment="Center"
                   Text="Squats" />
            <Label AbsoluteLayout.LayoutBounds="118, 90, 123, 72"
                   TextColor="#FFFEFE"
                   FontSize="28.50"
                   FontFamily="BreezeSans"
                   HorizontalTextAlignment="Center"
                   Text="{Binding SquatsCount}" />
            <Label AbsoluteLayout.LayoutBounds="148, 184, 64, 27"
                   FontFamily="BreezeSans"
                   FontSize="Small"
                   HorizontalTextAlignment="Center"
                   TextColor="#77A6D2"
                   Text="Time" />
            <Label AbsoluteLayout.LayoutBounds="133, 228, 94, 29"
                   TextColor="#FFFEFE"
                   FontFamily="BreezeSans"
                   FontSize="Large"
                   HorizontalTextAlignment="Center"
                   Text="{Binding Time}" />
            <AbsoluteLayout.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ChangeServiceStateCommand}" />
            </AbsoluteLayout.GestureRecognizers>
        </AbsoluteLayout>
    </cui:CirclePage.Content>

    <cui:CirclePage.ActionButton>
        <cui:ActionButtonItem Text="RESET"
                              BackgroundColor="#2a537d"
                              Command="{Binding ResetCommand}"/>
    </cui:CirclePage.ActionButton>

</cui:CirclePage>

```

**Step 3.** Let's implement trigger for disable the action button while time is counted..

<highlight>53-63</highlight>

```xml
<?xml version="1.0" encoding="utf-8" ?>
<cui:CirclePage xmlns="http://xamarin.com/schemas/2014/forms"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:viewModels="clr-namespace:SquatCounter.ViewModels;assembly=SquatCounter"
                xmlns:cui ="clr-namespace:Tizen.Wearable.CircularUI.Forms;assembly=Tizen.Wearable.CircularUI.Forms"
                x:Class="SquatCounter.Views.SquatCounterPage"
                NavigationPage.HasNavigationBar="False">

    <cui:CirclePage.BindingContext>
        <viewModels:SquatCounterPageViewModel />
    </cui:CirclePage.BindingContext>

    <cui:CirclePage.Content>
        <AbsoluteLayout>
            <Image AbsoluteLayout.LayoutBounds="0, 0, 360, 360"
                   Source="squat_background.png" />
            <Label AbsoluteLayout.LayoutBounds="130, 28, 100, 47"
                   TextColor="#77A6D2"
                   FontFamily="BreezeSans"
                   FontSize="Large"
                   HorizontalTextAlignment="Center"
                   Text="Squats" />
            <Label AbsoluteLayout.LayoutBounds="118, 90, 123, 72"
                   TextColor="#FFFEFE"
                   FontSize="28.50"
                   FontFamily="BreezeSans"
                   HorizontalTextAlignment="Center"
                   Text="{Binding SquatsCount}" />
            <Label AbsoluteLayout.LayoutBounds="148, 184, 64, 27"
                   FontFamily="BreezeSans"
                   FontSize="Small"
                   HorizontalTextAlignment="Center"
                   TextColor="#77A6D2"
                   Text="Time" />
            <Label AbsoluteLayout.LayoutBounds="133, 228, 94, 29"
                   TextColor="#FFFEFE"
                   FontFamily="BreezeSans"
                   FontSize="Large"
                   HorizontalTextAlignment="Center"
                   Text="{Binding Time}" />
            <AbsoluteLayout.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ChangeServiceStateCommand}" />
            </AbsoluteLayout.GestureRecognizers>
        </AbsoluteLayout>
    </cui:CirclePage.Content>

    <cui:CirclePage.ActionButton>
        <cui:ActionButtonItem Text="RESET"
                              BackgroundColor="#2a537d"
                              Command="{Binding ResetCommand}"/>
    </cui:CirclePage.ActionButton>

    <cui:CirclePage.Triggers>
        <DataTrigger TargetType="cui:CirclePage"
                     Binding="{Binding IsCounting}"
                     Value="True">
            <Setter Property="ActionButton">
                <Setter.Value>
                    <cui:ActionButtonItem IsVisible="False" />
                </Setter.Value>
            </Setter>
        </DataTrigger>
    </cui:CirclePage.Triggers>

</cui:CirclePage>

```

**Step 4.**  We also need modify file **_SquatCounterPage_** **_.xaml.cs_** with following code.

<highlight>1,5</highlight>

```csharp
using Tizen.Wearable.CircularUI.Forms;

namespace SquatCounter.Views
{
    public partial class SquatCounterPage : CirclePage
    {
        public SquatCounterPage()
        {
            InitializeComponent();
        }
    }
}

```

**Step 4.** At the last step we need to implement **_GoToSquatCounterPage_** method, which will push our page.

<highlight>20-23</highlight>

```csharp
using SquatCounter.Views;
using Xamarin.Forms;

namespace SquatCounter.Services
{
    public sealed class PageNavigationService
    {
        private static PageNavigationService _instance;

        public static PageNavigationService Instance
        {
            get => _instance ?? (_instance = new PageNavigationService());
        }

        public void GoToGuidePage()
        {
            Application.Current.MainPage = new NavigationPage(new GuidePage());
        }

        public async void GoToSquatCounterPage()
        {
            await Application.Current.MainPage.Navigation.PushAsync(new SquatCounterPage());
        }
    }
}


```

We have finished our app. Now after build and run app we can go to  **_SquatCounterPage_** from **_GuideClockPage_** .

<img src="/assets/images/tutorials/180/squatcounterpage.png" style="height:360px; width:360px"/>
